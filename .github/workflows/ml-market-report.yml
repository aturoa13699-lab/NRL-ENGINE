name: ml-market-report
on:
  schedule: [{ cron: "45 22 * * 2" }]  # Tue 09:45 AEST
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  report:
    # Run schedules only on default branch
    if: ${{ github.event_name != 'schedule' || github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Fetch data branch
        run: |
          git fetch origin data || true
          mkdir -p data_worktree
          if git rev-parse --verify origin/data >/dev/null 2>&1; then
            git worktree add --detach data_worktree origin/data
          fi
          mkdir -p data/exports data/sources reports
          if [ -d data_worktree/data/exports ]; then
            cp -r data_worktree/data/exports/* data/exports/ || true
          fi
          if [ -d data_worktree/data/sources ]; then
            cp -r data_worktree/data/sources/* data/sources/ || true
          fi

      - uses: actions/setup-python@v5
        with: { python-version: "3.11", cache: "pip" }

      - name: Install deps
        run: |
          pip install -q "pandas>=2" "pyarrow" "fastparquet" \
            "scikit-learn>=1.3" "scipy" "papermill" "nbconvert" "jupyter"

      - name: Check for training data
        id: datacheck
        run: |
          if [ -f data/exports/train_super_enriched_v2.csv ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "Training data found"
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "::warning::No train_super_enriched_v2.csv found; skipping training"
          fi

      - name: Run anchored training CLI
        if: steps.datacheck.outputs.has_data == 'true'
        run: |
          python -m tools.train_market_anchor \
            --data data/exports/train_super_enriched_v2.csv \
            --odds data/sources/odds.csv \
            --calibrate isotonic | tee reports/market_anchor_metrics.json || true

      - name: Create placeholder report if no data
        if: steps.datacheck.outputs.has_data != 'true'
        run: |
          mkdir -p reports
          echo '{"note": "no training data available", "time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > reports/market_anchor_metrics.json

      - name: Build HTML report (Papermill)
        run: |
          echo '{"params":{}}' > params.json
          if [ -f notebooks/60_market_anchored_training.ipynb ]; then
            papermill notebooks/60_market_anchored_training.ipynb \
              reports/60_market_anchored_out.ipynb -k python3 -f params.json || true
            jupyter nbconvert --to html --output-dir "reports" \
              "reports/60_market_anchored_out.ipynb" || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ml-market-report
          path: |
            reports/*.html
            reports/*.json
          retention-days: 14
          if-no-files-found: ignore

      - name: Publish report to data branch
        if: always()
        env:
          BR: data
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Always start from latest remote state if it exists
          git fetch origin --prune
          if git ls-remote --exit-code --heads origin "$BR" >/dev/null 2>&1; then
            git checkout -B "$BR" "origin/$BR"
          else
            git checkout -B "$BR"
          fi

          mkdir -p reports/market
          TS=$(date -u +%Y%m%dT%H%M%SZ)
          mkdir -p "reports/market/${TS}"

          # Copy reports
          cp reports/*.html "reports/market/${TS}/" 2>/dev/null || true
          cp reports/*.json "reports/market/${TS}/" 2>/dev/null || true

          # Update latest pointers
          rm -f reports/market/latest.html reports/market/metrics.json 2>/dev/null || true
          [ -f "reports/market_anchor_metrics.json" ] && cp "reports/market_anchor_metrics.json" reports/market/metrics.json
          [ -f "reports/60_market_anchored_out.html" ] && cp "reports/60_market_anchored_out.html" reports/market/latest.html

          git add reports/market/* || true
          git commit -m "reports: weekly market-anchored metrics ${TS}" || echo "nothing to commit"

          # Push with retries to handle race conditions
          n=0
          until [ $n -ge 3 ]; do
            git fetch origin "$BR" 2>/dev/null || true
            if git push --force-with-lease origin HEAD:refs/heads/$BR 2>/dev/null; then
              echo "âœ… Pushed to ${BR}"
              break
            fi
            n=$((n+1))
            delay=$((n*3))
            echo "Push race; retrying in ${delay}s..."
            sleep $delay
            # Rebase on latest remote
            git fetch origin "$BR" 2>/dev/null || true
            git rebase "origin/$BR" 2>/dev/null || git rebase --abort 2>/dev/null || true
          done
          [ $n -lt 3 ] || echo "::warning::Push to data branch failed after retries"

      - name: Job Summary
        run: |
          echo "### ML Market Report" >> $GITHUB_STEP_SUMMARY
          echo "- Reports artifact: **ml-market-report**" >> $GITHUB_STEP_SUMMARY
          echo "- Data branch path: \`reports/market/\`" >> $GITHUB_STEP_SUMMARY
